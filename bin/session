#!/usr/bin/env zsh

function tmuxs() {
    local selected
    if [[ $# -eq 1 ]]; then
        selected=$1
    else
        selected=$(fd --exact-depth 2 --type d --color never . "${DEV_ROOT:-"$HOME/dev"}" | ${FILTER_PROG:-fzf})
    fi

    if [[ -z $selected ]]; then
        exit 0
    fi

    local selected_name=$(basename "$selected" /)
    local tmux_running=$(pgrep tmux)

    if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
        tmux new-session -s $selected_name -c $selected
        exit 0
    fi

    if ! tmux has-session -t=$selected_name 2> /dev/null; then
        tmux new-session -ds $selected_name -c $selected
    fi

    if [[ -z $(tmux list-clients) ]]; then
        exec tmux attach -t $selected_name -c $selected
    else
        tmux switch-client -t $selected_name
    fi
}

function session() {
    local root=${DEV_ROOT:-"$HOME/dev"}
    local proj
    if [[ -n "$1" && -d "$root/$1" ]]; then
        proj="$root/$1"
    else
        proj=$(fd --exact-depth 2 --type d --color never . "$root" | ${FILTER_PROG:-fzf})
    fi
    if [[ -z $proj ]]; then
        exit 0
    fi
    echo "$proj"

    cd "$proj"
    # todo emit title change sequence
}

if [[ ${0:t} == "tmuxs" ]]; then
    tmuxs
else
    session
fi

